require_relative '../node_modules/react-native/scripts/react_native_pods'
require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'

platform :ios, '13.4'

target 'GenesisApp' do
  config = use_native_modules!

  use_react_native!(
    path: config[:reactNativePath],
    hermes_enabled: true
  )

  post_install do |installer|
    react_native_post_install(installer)

    # 1) Remove '-G' from project build settings (arrays/strings)
    (installer.pods_project.targets + installer.aggregate_targets.flat_map { |t| t.user_project.native_targets }).each do |t|
      t.build_configurations.each do |cfg|
        %w[OTHER_CFLAGS OTHER_CPLUSPLUSFLAGS OTHER_LDFLAGS].each do |key|
          val = cfg.build_settings[key]
          next if val.nil?
          if val.is_a?(Array)
            cfg.build_settings[key] = val.reject { |f| f == '-G' }
          elsif val.is_a?(String)
            cfg.build_settings[key] = val.gsub(/\b-G\b/, ' ').squeeze(' ').strip
          end
        end
      end
    end

    # 2) Also scrub '-G' in generated xcconfig files under Pods/Target Support Files
    pods_root = installer.sandbox.root # .../ios/Pods
    Dir.glob(File.join(pods_root, 'Target Support Files', '**', '*.xcconfig')).each do |f|
      txt = File.read(f)
      cleaned = txt.gsub(/\b-G\b/, ' ')
                   .gsub(/\s{2,}/, ' ')
                   .gsub(/,\s*,/, ',')
                   .gsub(/=\s*,/, '= ')
      if cleaned != txt
        File.write(f, cleaned)
        puts "ðŸ”§ scrubbed -G in #{File.basename(f)}"
      end
    end
  end
end
